/** Шаблонные ответы по ключевым словам. Fallback — предложение оставить заявку. */
const KEYWORD_RESPONSES: Array<{ keywords: string[]; answer: string }> = [
  {
    keywords: ['смета', 'смету', 'стоимость', 'цена', 'сколько стоит', 'расчет', 'рассчитать'],
    answer:
      'Для расчёта стоимости пришлите площадь объекта и тип работ (электромонтаж, слаботочные системы и т.д.). Можете воспользоваться калькулятором на сайте или оставить заявку — мы подготовим смету в течение 1–2 дней.',
  },
  {
    keywords: ['квартир', 'квартира', 'квартире'],
    answer:
      'Электромонтаж в квартире у нас от 1500 ₸/м². Включает установку щита, освещение, розетки, замену проводки. Оставьте заявку — подготовим точную смету под вашу планировку.',
  },
  {
    keywords: ['офис', 'офиса', 'коммерческ'],
    answer:
      'Для офисов и коммерческих помещений мы делаем электромонтаж, СКС, видеонаблюдение, контроль доступа. Стоимость от 2000 ₸/м². Напишите площадь и пожелания — рассчитаем смету.',
  },
  {
    keywords: ['гарантия', 'гарантию'],
    answer: 'На все виды работ мы даём гарантию 5 лет. В течение срока недостатки устраняем бесплатно.',
  },
  {
    keywords: ['срок', 'сроки', 'когда', 'долго'],
    answer:
      'Сроки зависят от объекта: 1-комн. квартира 6–14 дней, 2-комн. 10–20 дней, 3-комн. 15–30 дней. Точные сроки назовём после осмотра и сметы.',
  },
  {
    keywords: ['слаботочк', 'видеонаблюден', 'скс', 'лан'],
    answer:
      'Слаботочные системы: видеонаблюдение, СКС, LAN, контроль доступа — от 1000 ₸/точка. IT-инфраструктура и серверные — от 5000 ₸/точка. Опишите задачу — подготовим предложение.',
  },
  {
    keywords: ['привет', 'здравствуй', 'добрый день', 'хай'],
    answer:
      'Привет! Я помогу с вопросами по электромонтажу и слаботочным системам. Напишите, что вас интересует: смета, сроки, виды работ или оставьте заявку на расчёт.',
  },
];

const FALLBACK =
  'По вашему запросу лучше подготовить персональный ответ. Оставьте заявку — мы перезвоним и ответим на все вопросы. Или задайте вопрос иначе: смета, сроки, виды работ.';

function findResponse(userText: string): string {
  const lower = userText.toLowerCase().trim();
  for (const { keywords, answer } of KEYWORD_RESPONSES) {
    if (keywords.some((k) => lower.includes(k))) return answer;
  }
  return FALLBACK;
}

const delay = (ms: number) => new Promise((r) => setTimeout(r, ms));

export async function sendAssistantMessage(userMessage: string): Promise<string> {
  await delay(400 + Math.floor(Math.random() * 300));
  if (import.meta.env.DEV) {
    console.log('[mock] assistant:', userMessage);
  }
  return findResponse(userMessage);
}
